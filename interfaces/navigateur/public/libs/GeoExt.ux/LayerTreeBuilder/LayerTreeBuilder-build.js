/*! Igo - v1.1.0 - 2015-06-22 */
Ext.namespace("GeoExt.ux.tree"),GeoExt.ux.tree.LayerTreeBuilder=Ext.extend(Ext.tree.TreePanel,{CUSTOM_EVENTS:["layermanaged"],title:"Layers",otherLayersText:"Autres couches",baseLayersText:"Fond de carte",wmsLegendNodes:!0,vectorLegendNodes:!0,checkableContainerGroupNodes:!0,checkableLeafGroupNodes:!0,layerStore:null,enableDD:!1,loader:{applyLoader:!1,uiProviders:{custom_ui:Ext.extend(GeoExt.tree.LayerNodeUI,new GeoExt.tree.TreeNodeUIEventMixin)}},root:{nodeType:"async",children:[]},initComponent:function(){this.addEvents(this.CUSTOM_EVENTS),this.plugins=this.plugins||[],this.plugins.push({ptype:"gx_treenodecomponent"}),this.plugins.push(new GeoExt.ux.plugins.LayerTreeBuilderNodeAgent),GeoExt.ux.tree.LayerTreeBuilder.superclass.initComponent.call(this),this.layerStore||(this.layerStore=GeoExt.MapPanel.guess().layers),this.layerStore.on({add:this.onLayerAdded,remove:this.onLayerRemoved,scope:this}),this.layerStore.treeBuilder=this,this.on({afterrender:function(){this.layerStore.getCount()>0&&this.onLayerAdded(this.layerStore,this.layerStore.data.items)},scope:this})},onLayerRemoved:function(a,b,c){},onLayerAdded:function(a,b,c){Ext.each(b,function(a,b){var c=a.getLayer();return c.displayInLayerSwitcher===!1?void(c.group&&c.options&&c.options.group&&(delete c.group,delete c.options.group)):void(c.options&&void 0===c.options.group&&(c.options.group=c.isBaseLayer?this.baseLayersText:this.otherLayersText))},this),Ext.each(b,function(a,b){var c=a.getLayer();if(c.displayInLayerSwitcher!==!1){var d=c.options.group;if(""===d||null==d){var e={nodeType:"gx_layer",layer:c.name,layerStore:this.layerStore,isLeaf:!0,allowDrag:!1,checked:c.visibility};this.getRootNode().appendChild(e)}else{var f=c.options.group.split("/");this.addGroupNodes(f,this.getRootNode(),d,a)}this.fireEvent("layermanaged",c)}},this)},addGroupNodes:function(a,b,c,d){var e=this,f=a.shift(),g=this.getNodeByText(b,f),h=d.getLayer();if(!g){if(0==a.length){var i;i=f==this.baseLayersText||f==this.otherLayersText?function(a){return GeoExt.tree.LayerLoader.prototype.createNode.call(this,a)}:function(a){var b=this.store.getByLayer(a.layer);if(!b)return a.nodeType="node",this.uiProviders={custom_ui:Ext.extend(GeoExt.tree.LayerNodeUI,new GeoExt.tree.TreeNodeUIEventMixin)},GeoExt.tree.LayerLoader.prototype.createNode.call(this,a);var c=b.getLayer();return c instanceof OpenLayers.Layer.WMS&&e.wmsLegendNodes?(a.component={xtype:"gx_wmslegend",layerRecord:b,showTitle:!1,hidden:!c.visibility||c.hideInLegend||!c.inRange||c.legende===!1,cls:"gx-layertreebuilder-legend"},c.hideInLegend&&b.set("hideInLegend",c.hideInLegend)):c instanceof OpenLayers.Layer.Vector&&e.vectorLegendNodes&&(a.component={xtype:"gx_vectorlegend",layerRecord:b,showTitle:!1,hidden:!c.visibility||c.hideInLegend||!c.inRange||c.legende===!1,cls:"gx-layertreebuilder-legend"},c.hideInLegend&&b.set("hideInLegend",c.hideInLegend)),c.isBaseLayer||Ext.apply(a,{listeners:{checkchange:this.store.treeBuilder.checkChange}}),GeoExt.tree.LayerLoader.prototype.createNode.call(this,a)},g={text:f,layerStore:this.layerStore,allowDrag:!1,nodeType:"gx_layercontainer",leaf:!1,listeners:{insert:this.onLayerContainerNodeAdded,append:this.onLayerContainerNodeAdded,scope:this},loader:{filter:function(a){return a.getLayer().options.group!==c&&0===c.indexOf(a.getLayer().options.group)?!1:a.getLayer().options.group==c},baseAttrs:{uiProvider:"custom_ui"},createNode:i}}}else g={text:f,leaf:!1,listeners:{append:this.onTreeNodeAppend,scope:this},allowDrag:!1,nodeType:"node"};var j;j="gx_layercontainer"==g.nodeType?this.checkableLeafGroupNodes:this.checkableContainerGroupNodes&&this.checkableLeafGroupNodes,!j||f==this.baseLayersText||f==this.otherLayersText||h&&h.isBaseLayer||(Ext.apply(g,{checked:!1}),Ext.apply(g.listeners,{checkchange:function(a,b){a.getUI().isChecked()&&(a.expand(),a.eachChild(function(a){a.ui.toggleCheck(!0)})),a.getUI().isChecked()||(a.expand(),a.eachChild(function(a){a.ui.toggleCheck(!1)}))}})),b.appendChild(g),g=this.getNodeByText(b,f)}h&&h.visibility&&g.expand(),0!=a.length&&this.addGroupNodes(a,g,c,d)},getNodeByText:function(a,b){for(var c=0;c<a.childNodes.length;c++)if(a.childNodes[c].text==b)return a.childNodes[c];return!1},checkChange:function(a,b){function c(a){if("boolean"!=typeof a.attributes.checked)throw new Error(arguments.callee.name+" should only be called on checkbox nodes");var b=[];if(a.eachChild(function(a){"boolean"==typeof a.attributes.checked&&b.push(a)},this),0==b.length)return a.attributes.checked;var f=!0;return Ext.each(b,function(a){return c(a)?void 0:(f=!1,!1)},this),e.setNodeChecked(a,f,!1),delete d[a.id],f}var d={},e=a.getOwnerTree();e.setNodeChecked=function(a,b,c){var d=a instanceof Ext.data.Node?a:this.getNodeById(a);d&&"boolean"==typeof d.attributes.checked&&(void 0===b&&(b=!d.attributes.checked),d.attributes.checked=b,d.ui&&d.ui.checkbox&&(d.ui.checkbox.checked=b),(c||void 0===c)&&d.fireEvent("checkchange",d,b))};var f=[];e.getRootNode().cascade(function(a){"boolean"==typeof a.attributes.checked&&(f.push(a),d[a.id]=!0)},this);for(var a;a=f.shift();)d[a.id]&&c(a)},onLayerContainerNodeAdded:function(a,b,c){this.validateLayerContainerStatus(b)},validateLayerContainerStatus:function(a){var b;Ext.each(a.childNodes,function(a,c){return b=!0,a.layer&&a.layer.visibility?void 0:(b=!1,!1)});var c=a.getUI().checkbox;c&&(c.checked=b?!0:!1),b&&a.ensureVisible(),a.parentNode&&this.validateTreeNodeStatus(a.parentNode)},onTreeNodeAppend:function(a,b,c,d){this.validateTreeNodeStatus(b)},validateTreeNodeStatus:function(a){var b;if(this.checkableContainerGroupNodes&&!a.isRoot){Ext.each(a.childNodes,function(a,c){return b=!0,a.getUI().isChecked()?void 0:(b=!1,!1)});var c=a.getUI().checkbox;c&&(c.checked=b?!0:!1),a.parentNode&&this.validateTreeNodeStatus(a.parentNode)}}}),Ext.namespace("GeoExt.ux.plugins"),GeoExt.ux.plugins.LayerTreeBuilderNodeAgent=Ext.extend(Ext.util.Observable,{tree:null,init:function(a,b){this.tree=a,this.tree.on("layermanaged",this.onLayerManaged,this)},onLayerManaged:function(a){a.events.on({visibilitychanged:function(a){var b=a.object;if(b.visibility)if(b.layerContainer)b.layerContainer.ensureVisible(),b.layerContainer.expand();else if(b.options&&b.options.group){var c=b.options.group.split("/");this.expandTreeNodesFromGroup(c,this.tree.getRootNode(),b)}},scope:this})},expandTreeNodesFromGroup:function(a,b,c){var d=a.shift(),e=b.findChild("text",d);e&&(e.expand(),a.length>0?this.expandTreeNodesFromGroup(a,e,c):c.layerContainer=e)}});
//# sourceMappingURL=LayerTreeBuilder-build.js.map