<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Navigateur Source: menu/impression.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Navigateur</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-aide.html">aide</a>
						</li>
						
						<li>
							<a href="module-arborescence.html">arborescence</a>
						</li>
						
						<li>
							<a href="module-barreOutils.html">barreOutils</a>
						</li>
						
						<li>
							<a href="module-Blanc.html">Blanc</a>
						</li>
						
						<li>
							<a href="module-carte.html">carte</a>
						</li>
						
						<li>
							<a href="module-couche.html">couche</a>
						</li>
						
						<li>
							<a href="module-evenement.html">evenement</a>
						</li>
						
						<li>
							<a href="module-gestionCouches.html">gestionCouches</a>
						</li>
						
						<li>
							<a href="module-google.html">google</a>
						</li>
						
						<li>
							<a href="module-impression.html">impression</a>
						</li>
						
						<li>
							<a href="module-ligne.html">ligne</a>
						</li>
						
						<li>
							<a href="module-limites.html">limites</a>
						</li>
						
						<li>
							<a href="module-localisation.html">localisation</a>
						</li>
						
						<li>
							<a href="module-marqueurs.html">marqueurs</a>
						</li>
						
						<li>
							<a href="module-navigateur.html">navigateur</a>
						</li>
						
						<li>
							<a href="module-occurence.html">occurence</a>
						</li>
						
						<li>
							<a href="module-osm.html">osm</a>
						</li>
						
						<li>
							<a href="module-outil.html">outil</a>
						</li>
						
						<li>
							<a href="module-outilAide.html">outilAide</a>
						</li>
						
						<li>
							<a href="module-outilMenu.html">outilMenu</a>
						</li>
						
						<li>
							<a href="module-panneau.html">panneau</a>
						</li>
						
						<li>
							<a href="module-panneauAccordeon.html">panneauAccordeon</a>
						</li>
						
						<li>
							<a href="module-panneauCarte.html">panneauCarte</a>
						</li>
						
						<li>
							<a href="module-panneauEntete.html">panneauEntete</a>
						</li>
						
						<li>
							<a href="module-panneauInfo.html">panneauInfo</a>
						</li>
						
						<li>
							<a href="module-panneauMenu.html">panneauMenu</a>
						</li>
						
						<li>
							<a href="module-panneauOnglet.html">panneauOnglet</a>
						</li>
						
						<li>
							<a href="module-point.html">point</a>
						</li>
						
						<li>
							<a href="module-polygone.html">polygone</a>
						</li>
						
						<li>
							<a href="module-recherche.html">recherche</a>
						</li>
						
						<li>
							<a href="module-rechercheAdresse.html">rechercheAdresse</a>
						</li>
						
						<li>
							<a href="module-rechercheBorne.html">rechercheBorne</a>
						</li>
						
						<li>
							<a href="module-RechercheCadastreReno.html">RechercheCadastreReno</a>
						</li>
						
						<li>
							<a href="module-rechercheGPS.html">rechercheGPS</a>
						</li>
						
						<li>
							<a href="module-rechercheHQ.html">rechercheHQ</a>
						</li>
						
						<li>
							<a href="module-rechercheLieu.html">rechercheLieu</a>
						</li>
						
						<li>
							<a href="module-requireAide.html">requireAide</a>
						</li>
						
						<li>
							<a href="module-style.html">style</a>
						</li>
						
						<li>
							<a href="module-tms.html">tms</a>
						</li>
						
						<li>
							<a href="module-vecteur.html">vecteur</a>
						</li>
						
						<li>
							<a href="module-wms.html">wms</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="BarreOutils.html">BarreOutils</a>
						</li>
						
						<li>
							<a href="Carte.html">Carte</a>
						</li>
						
						<li>
							<a href="Couche.html">Couche</a>
						</li>
						
						<li>
							<a href="Couche.Blanc.html">Couche.Blanc</a>
						</li>
						
						<li>
							<a href="Couche.Google.html">Couche.Google</a>
						</li>
						
						<li>
							<a href="Couche.Marqueurs.html">Couche.Marqueurs</a>
						</li>
						
						<li>
							<a href="Couche.OSM.html">Couche.OSM</a>
						</li>
						
						<li>
							<a href="Couche.TMS.html">Couche.TMS</a>
						</li>
						
						<li>
							<a href="Couche.Vecteur.html">Couche.Vecteur</a>
						</li>
						
						<li>
							<a href="Couche.WMS.html">Couche.WMS</a>
						</li>
						
						<li>
							<a href="Evenement.html">Evenement</a>
						</li>
						
						<li>
							<a href="Geometrie.Ligne.html">Geometrie.Ligne</a>
						</li>
						
						<li>
							<a href="Geometrie.Limites.html">Geometrie.Limites</a>
						</li>
						
						<li>
							<a href="Geometrie.Occurence.html">Geometrie.Occurence</a>
						</li>
						
						<li>
							<a href="Geometrie.Point.html">Geometrie.Point</a>
						</li>
						
						<li>
							<a href="Geometrie.Polygone.html">Geometrie.Polygone</a>
						</li>
						
						<li>
							<a href="Geometrie.Style.html">Geometrie.Style</a>
						</li>
						
						<li>
							<a href="GestionCouches.html">GestionCouches</a>
						</li>
						
						<li>
							<a href="Navigateur.html">Navigateur</a>
						</li>
						
						<li>
							<a href="Outil.html">Outil</a>
						</li>
						
						<li>
							<a href="Outil.OutilAide.html">Outil.OutilAide</a>
						</li>
						
						<li>
							<a href="OutilMenu.html">OutilMenu</a>
						</li>
						
						<li>
							<a href="Panneau.html">Panneau</a>
						</li>
						
						<li>
							<a href="Panneau.Arborescence.html">Panneau.Arborescence</a>
						</li>
						
						<li>
							<a href="Panneau.Impression.html">Panneau.Impression</a>
						</li>
						
						<li>
							<a href="Panneau.Localisation.html">Panneau.Localisation</a>
						</li>
						
						<li>
							<a href="Panneau.PanneauAccordeon.html">Panneau.PanneauAccordeon</a>
						</li>
						
						<li>
							<a href="Panneau.PanneauAccordeon.PanneauMenu.html">Panneau.PanneauAccordeon.PanneauMenu</a>
						</li>
						
						<li>
							<a href="Panneau.PanneauCarte.html">Panneau.PanneauCarte</a>
						</li>
						
						<li>
							<a href="Panneau.PanneauEntete.html">Panneau.PanneauEntete</a>
						</li>
						
						<li>
							<a href="Panneau.PanneauInfo.html">Panneau.PanneauInfo</a>
						</li>
						
						<li>
							<a href="Panneau.PanneauOnglet.html">Panneau.PanneauOnglet</a>
						</li>
						
						<li>
							<a href="Panneau.Recherche.html">Panneau.Recherche</a>
						</li>
						
						<li>
							<a href="Panneau.RechercheAdresse.html">Panneau.RechercheAdresse</a>
						</li>
						
						<li>
							<a href="Panneau.RechercheBorne.html">Panneau.RechercheBorne</a>
						</li>
						
						<li>
							<a href="Panneau.RechercheCadastreReno.html">Panneau.RechercheCadastreReno</a>
						</li>
						
						<li>
							<a href="Panneau.RechercheGPS.html">Panneau.RechercheGPS</a>
						</li>
						
						<li>
							<a href="Panneau.RechercheHQ.html">Panneau.RechercheHQ</a>
						</li>
						
						<li>
							<a href="Panneau.RechercheLieu.html">Panneau.RechercheLieu</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="mixins.list.html" class="dropdown-toggle" data-toggle="dropdown">Mixins<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="helper.Aide.html">Aide</a>
						</li>
						
						<li>
							<a href="helper.require.html">require</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Couche.Vecteur.html#event:ajouterOccurence">ajouterOccurence</a>
						</li>
						
						<li>
							<a href="Couche.Vecteur.html#event:deselectionnerOccurence">deselectionnerOccurence</a>
						</li>
						
						<li>
							<a href="Couche.Vecteur.html#event:deselectionnerTout">deselectionnerTout</a>
						</li>
						
						<li>
							<a href="Couche.Vecteur.html#event:enleverOccurence">enleverOccurence</a>
						</li>
						
						<li>
							<a href="Couche.Vecteur.html#event:selectionnerOccurence">selectionnerOccurence</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: menu/impression.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">/** 
 * Module pour l'objet {@link Panneau.Impression}.
 * @module impression
 * @author Marc-André Barbeau, MSP
 * @version 1.0
 * @requires panneau
 * @requires wms2pdf
 */

define(['panneau', 'aide'], function(Panneau, Aide) {
    /** 
     * Création de l'object Panneau.Impression.
     * Objet à ajouter à un panneauMenu.
     * @constructor
     * @name Panneau.Impression
     * @class Panneau.Impression
     * @alias impression:Panneau.Impression
     * @extends Panneau
     * @requires impression
     * @returns {Panneau.Impression} Instance de {@link Panneau.Impression}
    */
    function Impression(options){
        this.options = options || {};
        
        //todo
        this.defautOptions.service= "/igo/services/impression/printIGO.php"
         
        this.separator = "&amp;";
        this.aszPrintableLayerTypes = [
            "OpenLayers.Layer.WMS",
            "OpenLayers.Layer.WMS.Untiled",
            "OpenLayers.Layer.MapServer"
        ];
    };
    
    Impression.prototype = new Panneau();
    Impression.prototype.constructor = Impression;
    
    /** 
     * Initialisation de l'object Impression. 
     * @method 
     * @name Impression#_init
    */
    Impression.prototype._init = function(){
        this.wms2pdf();
        this._panel = {						
            title: 'Impression', 
            id: 'widgetImpression',
            hidden: false,
            border: true,
            width: 200,
            split: true,
            collapsible: true,
            collapseMode: "mini",
            autoScroll: true,
            items:[this.printForm]
        };
    };


Impression.prototype.wms2pdf = function(){
    var that=this;
    // outputformat
    var oOutputFormatStore = new Ext.data.SimpleStore({
        fields: ['value', 'text'],
        data : [['img', 'Image'],['pdf', 'Document PDF']]
    });
    var szDefaultOutputFormat = oOutputFormatStore.data.items[0].data.value;
    var oOutputFormatComboBox = new Ext.form.ComboBox({
        id : 'printOutputFormat',
        fieldLabel: 'Format',
        store: oOutputFormatStore,
        valueField: 'value',
        value: szDefaultOutputFormat,
        displayField:'text',
        editable: false,
        mode: 'local',
        triggerAction: 'all',
        lazyRender: true,
        lazyInit: false,
        listWidth: 150
    });

    oOutputFormatComboBox.on('change', function(){
        var nKey =  that.printForm.items.indexOfKey("printComments");
    });

    // paper size
    var oPaperStore = new Ext.data.SimpleStore({
        fields: ['value', 'text'],
        data : [
                ['LETTER', 'Lettre	8.5 X 11'],
                ['LEGAL', 'Legal	8.5 X 14'],
                ['LEDGER', 'Tabloid	11 X 17'],
                ['A1', 'A1	23 X 33'],
                ['ANSI E', 'ANSI E	34 X 44'],
                ['Personalisé', 'Personalisé']
        ]
    });
    var szDefaultPaper = oPaperStore.data.items[0].data.value;

    var oPaperComboBox = new Ext.form.ComboBox({
        id : 'printPaper',
        fieldLabel: 'Format papier',
        store: oPaperStore,
        valueField: 'value',
        value: szDefaultPaper,
        displayField:'text',
        editable: false,
        mode: 'local',
        triggerAction: 'all',
        lazyRender: true,
        lazyInit: false,
        listWidth: 150
    });
    
    var widthNumberField = new Ext.form.NumberField({
    	id: 'width',
        fieldLabel: 'Largeur',
        name: 'width',
        decimalPrecision:1,
        value: 11,
        minValue:8.5,
        maxValue:44
    });
    widthNumberField.setDisabled(true);
    
    var heightNumberField = new Ext.form.NumberField({
    	id:'height',
        fieldLabel: 'Hauteur',
        name: 'height',
        decimalPrecision:1,
        value:8.5,
        minValue:8.5,
        maxValue:44
    });
    heightNumberField.setDisabled(true);
    
    // When the paper selection changes, update the width &amp; height NumberFields.
    oPaperComboBox.on( 'select', function() {   
    		updatePaperNumberFields();
        });
    
    function updatePaperNumberFields(){
		var paper = oPaperComboBox.getValue();
		var orientation = oOrientationComboBox.getValue();
		
		var width = widthNumberField.getValue();
		var height = heightNumberField.getValue();
		
		if(paper == "Personalisé"){
			widthNumberField.setDisabled(false);
			heightNumberField.setDisabled(false);
		}
		else{
			if(paper == "LETTER"){
				width = 8.5;
				height = 11;
			}else if(paper == "LEGAL"){
				width = 8.5;
				height = 14;
			}else if(paper == "LEDGER"){
				width = 11;
				height = 17;
			}else if(paper == "A1"){
				width = 23;
				height = 33;
			}else if(paper == "ANSI E"){
				width = 34;
				height = 44;
			}
			widthNumberField.setDisabled(true);
			heightNumberField.setDisabled(true);
			
			if(orientation == "landscape"){
				// Invert width &amp; height
				var buffer = width;
				width = height;
				height = buffer;
			}
		}		
		widthNumberField.setValue(width);
		heightNumberField.setValue(height);		
    }
    
    var showLegendOption = new Ext.form.Checkbox(
    {
    	id : 'showLegendGraphics',
    	boxLabel : ' Afficher la Légende'
    });
    

    // paper orientation
    var oOrientationStore = new Ext.data.SimpleStore({
        fields: ['value', 'text'],
        data : [['landscape', 'Paysage'],
                ['portrait', 'Portrait']]
    });
    var szDefaultOrientation = oOrientationStore.data.items[0].data.value;

    var oOrientationComboBox = new Ext.form.ComboBox({
        id : 'printOrientation',
        fieldLabel: 'Orientation',
        store: oOrientationStore,
        valueField: 'value',
        value: szDefaultOrientation,
        displayField:'text',
        editable: false,
        mode: 'local',
        triggerAction: 'all',
        lazyRender: true,
        lazyInit: false,
        listWidth: 150
    });
    
    // When the PaperComboBox value changes, update the paper number fields.
    oOrientationComboBox.on( 'select', function() {   
            updatePaperNumberFields();
    });
    

    

    // units
    var oUnitsStore = new Ext.data.SimpleStore({
        fields: ['value', 'text'],
        data : [['default', 'Celle de la carte'],
                ['in', 'Pouces'],['ft', 'Pieds'],['mi', 'Miles'],
                ['m', 'Mètres'],['km', 'Kilomètres'],['dd', 'Degrés']]
    });
    var szDefaultUnits = oUnitsStore.data.items[0].data.value;

    var oUnitsComboBox = new Ext.form.ComboBox({
        id : 'printUnits',
        fieldLabel: 'Unité',
        store: oUnitsStore,
        valueField: 'value',
        value: szDefaultUnits,
        displayField:'text',
        editable: false,
        mode: 'local',
        triggerAction: 'all',
        lazyRender: true,
        lazyInit: false,
        listWidth: 150
    });


    // the form
    this.printForm = new Ext.FormPanel({
        labelWidth: 100, // label settings here cascade unless overridden
        frame:true,
        border: false,
        bodyStyle:'padding:5px 5px 0',
        //width: 298, //enlever MAT 2011-07-18, mis auto-scroll 
        defaults: {width: 150},
        defaultType: 'textfield',
        items: [{
            fieldLabel: 'Titre',
            id: 'printTitle',
            maxLength: 50
        },{
            xtype: 'textarea',
            fieldLabel: 'Commentaires',
            id: 'printComments',
            height: 100,
            maxLength: 256
        }, oOutputFormatComboBox, oPaperComboBox, widthNumberField, heightNumberField, showLegendOption, oOrientationComboBox, oUnitsComboBox
        ],
        buttons: [{
            id: 'printButton',
            text: 'Imprimer',
            tooltip: 'Générer un fichier pdf de la carte présente',
            handler: function(){
                that.printMap();
            }
        },{
            text: 'Restaurer',
            tooltip: 'Réinitialiser les valeurs des champs',
            handler: function(){
                that.printForm.getForm().reset();
            }
        }]
    });
}

/**
 * Function: printMap
 *
 * Get all visible and printable layers currently on map.  Get all required
 * parameters and build a request url string to be putted in a Ext.Window that
 * contains an iframe.  The actual "printing" (image/pdf generation) is done
 * server-side by the url (wms2pdf.php).
 *
 * In the end, an image or pdf appears in the Ext.Window.  See wms2pdf.php for
 * more details on how the actual "printing" works.
 */
Impression.prototype.printMap = function(){
    var aoLayers = this.getPrintableLayers();
    //Ajouter une validation si la carte de base est GOOGLE = empÃƒÂªcher l'impression
    // If no printable layers were found, stop and  error
    if(!aoLayers){
        var szTitle = "Impression";
        var szMsg = "Les couches Google et OpenStreetMap, ne sont pas disponible à l'impression pour des raisons de  droits d'utilisation.";

        Aide.afficherMessage(szTitle, szMsg);
        return;
    }

    
    //Lancer l'impression
    var szURL = this.options.service || this.defautOptions.service;
    var oParams = this.getPrintParams(aoLayers);
    var szTitle = "Création du fichier";
    var szWait = "Création du fichier en cours, veuillez patienter quelques"+
                 " secondes...";

    // STANDARD WAY --> open the url in a new window
    var szParams = OpenLayers.Util.getParameterString(oParams);
    if(szParams.length > 0) {
        szURL += this.separator + szParams;
    }
  
    
    //Ajouter le chemin et la position de l'icÃƒÂ´ne de localisation
    //HypothÃƒÂ¨se: la carte a au maximum un seul layer de type OpenLayers.Layer.Markers et l'icÃƒÂ´ne de localisation
    //est le premier marker sur cette couche
    //todo: à changer...
    var oRechercheForm = Aide.obtenirNavigateur().obtenirPanneauxParType('PanneauMenu')[0].obtenirPanneauxParType('Localisation')[0].obtenirPanneaux()[0]._getPanel();
	if(oRechercheForm.findByType('checkbox')[0].getValue())
	{
		var markersLayers = Igo.nav.carte._carteOL.getLayersByClass('OpenLayers.Layer.Markers');

		if (markersLayers.length > 0)
		{
			if (markersLayers[0].markers.length > 0)
			{
					var oMarkerLocalisation = markersLayers[0].markers[0];
					// patch pour l'impression en 32198, voir bogue mantis #000952
					oMarkerLocalisation.lonlat.transform(new OpenLayers.Projection('EPSG:900913'), new OpenLayers.Projection('EPSG:32198'));
					var reproject_oMarker32198 = oMarkerLocalisation.lonlat.toShortString();
					oMarkerLocalisation.lonlat.transform(new OpenLayers.Projection('EPSG:32198'), new OpenLayers.Projection('EPSG:900913'));
					
					//Sérialiser dans l'url les infos nécessaires pour redessiner l'icÃƒÂ´ne (son url et sa position)
					szParams = OpenLayers.Util.getParameterString(
						{
							'locimgsize':oMarkerLocalisation.icon.size.w.toString() + ',' + oMarkerLocalisation.icon.size.h.toString(),
							'locimgoffset':oMarkerLocalisation.icon.offset.x.toString() + ',' + oMarkerLocalisation.icon.offset.y.toString(),
							'locimg':oMarkerLocalisation.icon.url,
							'locpos':oMarkerLocalisation.lonlat.toShortString(),
							// patch pour l'impression en 32198, voir bogue mantis #000952
							'locpos_32198':reproject_oMarker32198
						});
						
			szURL += this.separator + szParams;
			}
		}
	}
 

    // The Cosmetic layer is added by the red lining panel.
    var annotation = Igo.nav.carte._carteOL.getLayersByName('Cosmetic');
    if (annotation.length > 0){   	
    	GeoExt.ux.data.Export.format = 'KML';
    	GeoExt.ux.data.Export.content = GeoExt.ux.data.Export(Igo.nav.carte._carteOL, GeoExt.ux.data.Export.format, annotation, null); 
    	var kmlData = GeoExt.ux.data.Export.content.replace(/&amp;lt;/g, '&lt;').replace(/&amp;gt;/g, '>');
    	var ps = OpenLayers.Util.getParameterString({'annotation':kmlData});
        szURL += this.separator + ps;
    } 
    
    
    
    
    
    
    	var szURL = this.exportVecteur(szURL, this.separator, 'GeoJSON'); 


    // 09/05/06 removed by adube : not used anymore because didn't work in IE
    // TODO : apply afficherMsg instead ?  If so, should automatically hides
    // itself...
    //showMsg(szTitle, szWait);

    oMapComponent = Igo.nav.obtenirPanneauxParType('PanneauCarte')[0]._getMapComponent();
    var nWinHeight = oMapComponent.getSize().height;
    var nWinWidth = oMapComponent.getSize().width;
    var nIFrameHeight = nWinHeight - 32;
    var nIFrameWidth = nWinWidth - 15;
    
    
    var proxy = Aide.obtenirProxy() + '?url=';
    szURL=proxy+szURL;

    	var req = new XMLHttpRequest();
    	if (req) {
                    req.onreadystatechange = function() {
                             var mConfig = { 
                                           mediaType   :'PDF', 
                                           url         : 'temp.pdf',//pdf file path
                                           unsupportedText : 'Acrobat Viewer is not Installed',
                                           resizable   : true
                             };
				 
	    	    if (req.readyState == 4 &amp;&amp; (req.status == 200 || req.status == 304)) {

	    	    	var htmlContent = null;
	    	    	if(req.responseText.indexOf("html") == -1){
	    	    		htmlContent = "&lt;iframe src=" + req.responseText + " width='" + nIFrameWidth + "px' height='"+nIFrameHeight+"px'>"
	    	    	}else{
	    	    		htmlContent = req.responseText;
	    	    	}
	    	    	
	    	    	this.oPDFWindow = new Ext.Window({
	    	    		title    : this.szWindowTitle,
	    	    		closable : true,
	    	    		width    : nWinWidth,
	    	    		height   : nWinHeight,
	    	    		border : false,
	    	    		modal: true,
	    	    		plain    : true,
	    	    		resizable : true,
	    	    		constrain: true,
	    	    		region: 'center',
	    	    		mediaCfg : mConfig,
	    	    		xtype: 'application/pdf',
	    	    		items: [{
	    	    			html: htmlContent,
	    	    			border: false
	    	    		}]
	    	    	});
	    		    var oPrintButton = Ext.get('printButton');
					Ext.MessageBox.hide();
	    		    this.oPDFWindow.show(oPrintButton); 					
	    	    }
			};
                        req.open('POST',Aide.obtenirProxy());
			req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
			             
                        var data = szURL.split('?')[1];
			req.send(data);

			Ext.MessageBox.show({
				msg: "Veuillez patienter pendant l'impression!",
				progressText: 'Chargement...',
				width:300,
				wait:true,
				waitConfig: {interval:200}
			});

    }   
}

Impression.prototype.getPrintableLayers = function(){
    var aolBase = [], aolOverlays = [], aoLayers;

    var oMap = Igo.nav.carte._carteOL;
    for (var i=0, len=oMap.layers.length; i&lt;len; i++) {
        var oLayer = oMap.layers[i];
        if(!oLayer.printOptions){
                if(oLayer.CLASS_NAME == "OpenLayers.Layer.Google" &amp;&amp; oLayer.getVisibility())
                        return false
                if(oLayer.CLASS_NAME == "OpenLayers.Layer.OSM.Mapnik" &amp;&amp; oLayer.getVisibility())
                        return false
                continue; 
        }


        if(OpenLayers.Util.indexOf(this.aszPrintableLayerTypes, oLayer.CLASS_NAME) == -1 &amp;&amp;
           ((!oLayer.printOptions['url'] ||
             !oLayer.printOptions['layers'] ||
             !oLayer.printOptions['mapformat'] ||
             !oLayer.printOptions['format']) ||
            oLayer.printOptions['fromLayer'] == true)){
            continue;
        }

        if (oLayer.isBaseLayer) {
            
            if (oLayer.getVisibility()){
                
                aolBase.push(oLayer);
            }
        } else if(oLayer.inRange &amp;&amp; oLayer.getVisibility()){
            aolOverlays.push(oLayer);
        }
    }

    // if(aolBase.length != 1){
        // return false
    // }

    aoLayers = aolBase.concat(aolOverlays);


    if(aoLayers.length===0){
        Aide.afficherMessage('Impression', "Aucune couche imprimable n'est sélectionnée");
    }
    
    return aoLayers;
};

Impression.prototype.getPrintParams = function(aoLayers){
	// Patch pour pallier ÃƒÂ  l'erreur de la projection Google avec le paramÃƒÂ¨tre geodesic ÃƒÂ  true dans le GOLOC, voir mantis #	0000874
    var bbox_reprojete = new OpenLayers.Bounds.fromString(Igo.nav.carte._carteOL.getExtent().toBBOX());
    bbox_reprojete.transform(new OpenLayers.Projection('EPSG:900913'), new OpenLayers.Projection('EPSG:32198'));
	
	var hasBaseLayer = false;
	for(var i = 0; i &lt; aoLayers.length; i++){
		if(aoLayers[i].isBaseLayer){
			hasBaseLayer = true;
			break;
		}
	}
			
   var oParams = {
       'BBOX':      bbox_reprojete.toBBOX(), // patch mantis #	0000874
       'SRS':       "EPSG:32198", // patch mantis #	0000874
       'SCALE':     Igo.nav.carte._carteOL.getScale(),
        //'MAPFORMAT': getLayerPrintOption(aoLayers[0], "mapformat"),
        'MAPFORMAT': 'png',
		'LAYERS':    this.getLayersPrintOption(aoLayers, "layers"),
		'TIME':    	 this.getLayersPrintOption(aoLayers, "time"),
        'URLS':      this.getLayersPrintOption(aoLayers, "url"),
        'FORMAT':    this.getLayersPrintOption(aoLayers, "format"),
		'OPACITY': 	 this.getLayersPrintOption(aoLayers, "opacity"),
		'HASBASELAYER' : hasBaseLayer
    };
    
    // user parameters
    var aoElements, nElements;
    aoElements = this.printForm.items.items;
    for (var i=0, len=aoElements.length; i&lt;len; i++){
        oElement = aoElements[i];
        oParams[oElement.getId()] = oElement.getValue();

        if(oElement.getId() == "printOutputFormat"){
            szOutputFormat = oElement.getValue();
            switch(szOutputFormat){
              case "pdf":
                this.szWindowTitle = "Présente carte en PDF.";
                break;
              default:
                this.szWindowTitle = "Présente carte en image.  Clique droit "+
                                "sur l'image pour la sauvegarder.";
            }
        }else if(oElement.getId() == "printPaper" || oElement.getId() == "printOrientation"){
        	// Do not send the print paper/orientation, this is application specific, 
        	// the services requires a width and a height parameter and does not know about the paper formats.
        	continue;
        }
    }
    return oParams;
}

Impression.prototype.getLayersPrintOption = function(aoLayers, szOption){
    var szOptionValues = "";

	for (var i=0, len=aoLayers.length; i&lt;len; i++) {
		var oLayer = aoLayers[i];

		if(i>0){
		    szOptionValues += '#';
		}

		szOptionValues += this.getLayerPrintOption(oLayer, szOption);
		
		//Changer les urls de layers pour que ça soit en http
		/*if ( szOption == 'url'){
			var host = Host.obtenir();
			switch(host){
				case 'https://egl.msp.gouv.qc.ca/':
					szOptionValues = szOptionValues.replace ("https://egl.","http://geoegl.");
					break;
				case 'https://geoegl.msp.gouv.qc.ca/':
					szOptionValues = szOptionValues.replace ("https://geoegl.","http://geoegl.");
					break;
				case 'https://preegl.msp.gouv.qc.ca/':
					szOptionValues = szOptionValues.replace ("https://preegl.","http://pregeoegl.");
					break;
				case 'https://pregeoegl.msp.gouv.qc.ca/':
					szOptionValues = szOptionValues.replace ("https://pregeoegl.","http://pregeoegl.");
					break;
			}
		}*/
	}
	
    return szOptionValues;
}

/**
 * Function: getLayersPrintOption
 *
 * Return a given print option value of a layer.  Each layer type and option
 * type is treated separately.
 *
 * Parameters:
 * oLayer   - {&lt;OpenLayers.Layer>}  A printable OpenLayer.Layer object
 * szOption - {string}              A possible option of the layer printOptions
 *                                  properties.  See readme at beginning for
 *                                  for more details.
 *
 * Returns:
 * {string}  Layer print option needed for the server-side printing script
 * 
 */
Impression.prototype.getLayerPrintOption = function(oLayer, szOption){
    var szOptionValue = oLayer.printOptions[szOption];

    if(szOptionValue){
        return szOptionValue;
    }

    switch(szOption){

      case "url":
        var szURL;
        if (oLayer.url instanceof Array &amp;&amp; oLayer.url.length > 1){
            szURL = oLayer.url[0];
        } else {
            szURL = oLayer.url;
        }
        var oParam = OpenLayers.Util.upperCaseObject(oLayer.params);
        var szMap = oParam.MAP;

        // if the layer has a 'map' param and it is not in the url, add it.
        if (szMap &amp;&amp;
            (szURL.indexOf('map=') == -1 || szURL.indexOf('MAP=') == -1)){
            var szMapParam = "map="+szMap;
            szURL += szMapParam + this.separator;
        }

        //szURL = encodeURIComponent(szURL);

        szOptionValue = szURL;
        break;

      case "layers":
        var oParam = OpenLayers.Util.upperCaseObject(oLayer.params);
        szOptionValue = oParam.LAYERS;
        break;

      case "format":
        switch(oLayer.CLASS_NAME){
          case "OpenLayers.Layer.WMS":
          case "OpenLayers.Layer.WMS.Untiled":
            szOptionValue = oLayer.params.FORMAT;
            break;
          case "OpenLayers.Layer.MapServer":
            szOptionValue = oLayer.params.map_imagetype;
            break;
        }
        break;

      case "mapformat":
        szOptionValue = 'png';
        break;
	
		case "opacity":
			szOptionValue = oLayer.opacity;
		break;
		
		case "time":
			if (oLayer.params['TIME']){
			szOptionValue = oLayer.params['TIME'];
			}else{
			szOptionValue = "null";
			}
		break;
    }    

    return szOptionValue;
}

Impression.prototype.exportVecteur = function(szURL, separator, format){
    var exportFeatures = [];
    var exportIcones = [];
    var vecteurCouches = Igo.nav.carte.gestionCouches.obtenirCouchesParType('Vecteur');

    $.each(vecteurCouches, function(key, couche){
        if(!couche.estActive()){return true;}
        var occurences = couche.obtenirOccurences();
        $.each(occurences, function(key, occurence){
            if(!occurence.estVisible()){return true;}
            
            if(occurence.obtenirProprieteStyle('icone')){
                var geom32198=occurence.projeter('EPSG:900913', 'EPSG:32198');
                var urlIcone = occurence.obtenirProprieteStyle('icone');
                //todo: icone detecter si lien relatif ou pas. L'image doit être visible du web...
                var icone = {
                    url: occurence.obtenirProprieteStyle('icone'),
                    geom32198: [geom32198.x, geom32198.y],
                    size: [occurence.obtenirProprieteStyle('iconeLargeur'),occurence.obtenirProprieteStyle('iconeHauteur')],
                    offset: [occurence.obtenirProprieteStyle('iconeOffsetX'),occurence.obtenirProprieteStyle('iconeOffsetY')]
                };
                exportIcones.push(icone);
                return true;
            }

            var clone = occurence._vector.clone();
            clone.attributes.msType=occurence.type;
            clone.attributes.msRayon=occurence.obtenirProprieteStyle('rayon');
            clone.attributes.msCouleur=occurence.obtenirProprieteStyle('couleur');
            clone.attributes.msOpacite=occurence.obtenirProprieteStyle('opacite')*100;
            clone.attributes.msLimiteCouleur=occurence.obtenirProprieteStyle('limiteCouleur');
            clone.attributes.msLimiteEpaisseur=occurence.obtenirProprieteStyle('limiteEpaisseur');
            clone.attributes.mslimiteOpacite=occurence.obtenirProprieteStyle('limiteOpacite')*100;
            exportFeatures.push(clone);
        });
    });

    if (exportIcones.length != 0){
        var ps = OpenLayers.Util.getParameterString({'icones':JSON.stringify(exportIcones)});
        szURL += separator + ps;	
    }
    
    if(exportFeatures.length == 0){
        return szURL;
    }

    var dataConvertie;
    if (format == 'KML') {
        var kmlWriter = new OpenLayers.Format.KML({
            externalProjection: new OpenLayers.Projection("EPSG:4326"),
            internalProjection: map.getProjectionObject()
        });
        dataConvertie = kmlWriter.write(exportFeatures);
    } else if (format == 'GeoJSON') {
        var geojsonWriter = new OpenLayers.Format.GeoJSON();
        dataConvertie = geojsonWriter.write(exportFeatures);
    } else if (format == 'GML') {
        var gmlWriter = new OpenLayers.Format.GML();
        dataConvertie = gmlWriter.write(exportFeatures);
    } else {
        return szURL;
    }
    
    var ps = OpenLayers.Util.getParameterString({'vecteurs':dataConvertie});
    szURL += separator + ps;	
    return szURL;
};
  
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    return Impression;
    
});












</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		Navigateur Copyright © 2014
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a>
		on Wed Jun 18 2014 14:09:12 GMT-0400 (EDT) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
			    anchorName  : function(i, heading, prefix) {
					return $(heading).attr("id") || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
